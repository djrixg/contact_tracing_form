
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Web QR Scanner</title>

  <link rel="stylesheet" rel="preload" as="style" onload="this.rel='stylesheet';this.onload=null" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
  <!-- <link rel="stylesheet" rel="preload" as="style" onload="this.rel='stylesheet';this.onload=null" href="https://unpkg.com/normalize.css@8.0.0/normalize.css"> -->
  <!-- <link rel="stylesheet" rel="preload" as="style" onload="this.rel='stylesheet';this.onload=null" href="https://unpkg.com/milligram@1.3.0/dist/milligram.min.css"> -->
  <link rel="stylesheet" type="text/css" href="../bootstrap.min.css">
  <script type="text/javascript" src="../jquery.min.js"></script>
  <script type="text/javascript" src="../jquery-3.2.1.slim.min.js"></script>
  <script type="text/javascript" src="../bootstrap.min.js"></script>
  <script type="text/javascript" src="../qrcode.min.js"></script>
  <script type="text/javascript" src="../jquery.cookie.js"></script>
</head>

<body>
<div class="container d-none mt-5" id="view_history">
  <table class="table table-sm dataTable">
    <thead>
      <tr>
        <th>Datetime</th>
        <th>Name</th>
        <th>Temp</th>
        <th>#</th>
        <th>Address</th>
        <th>City</th>
        <th>Province</th>
        <th>Questions</th>
      </tr>
    </thead>
    <tbody id="history_list">
    </tbody>
  </table>
  <footer class="footer">
    <div class="container pr-5">
      <button class="btn btn-outline-primary float-right" onclick='$("#view_history").addClass("d-none");$("#input_data").removeClass("d-none");'>Back</button>
      <button class="btn btn-outline-success" id="export">Export</button>
      <button class="btn btn-outline-danger" onclick="clear_data()">Clear Data</button>
    </div>
  </footer>
</div>
<div class="container" id="input_data">
<div class="btn-group-vertical jumbotron col-sm-12" id="main_screen" role="group" aria-label="keypad">
  <h3 class="h3">Enter Temperature: </h3>
    <div class="btn-group">
        <input class="text-center form-control mb-2" onkeyup="check($(this))" id="temp" autofocus>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary py-3" onclick="change('1');">1</button>
        <button type="button" class="btn btn-outline-secondary py-3" onclick="change('2');">2</button>
        <button type="button" class="btn btn-outline-secondary py-3" onclick="change('3');">3</button>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary py-3" onclick="change('4');">4</button>
        <button type="button" class="btn btn-outline-secondary py-3" onclick="change('5');">5</button>
        <button type="button" class="btn btn-outline-secondary py-3" onclick="change('6');">6</button>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary py-3" onclick="change('7');">7</button>
        <button type="button" class="btn btn-outline-secondary py-3" onclick="change('8');">8</button>
        <button type="button" class="btn btn-outline-secondary py-3" onclick="change('9');">9</button>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary py-3" onclick="change('.');">.</button>
        <button type="button" class="btn btn-outline-secondary py-3" onclick="change('0');">0</button>
        <button type="button" class="btn btn-outline-secondary py-3" onclick="change(null)">&lt;</button>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-primary py-3" onclick="scan_qr()">Go</button>
    </div>
  <label for="decoding-style">Scan Mode:</label>
  <select id="decoding-style" class="form-control" onchange="change_mode()" size="1">
    <option value="once">Single</option>
    <option value="continuously">Continuous (Without temperature and DTI form input)</option>
  </select>
  <br>
  <button type="button" class="btn btn-outline-secondary py-3" onclick="history()">History</button>
</div>
  <!-- <button class="btn btn-primary" onclick="scan_qr()">Scan QR</button> -->
</div>
<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">Scan customer QR</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modal_body">
        <section class="container" id="demo-content">
              <div class="d-none">
                <a class="button" id="startButton">Start</a>
                <a class="button" id="resetButton">Reset</a>
              </div>

              <div>
                <video id="video" width="100%" height="100%" style="border: 1px solid gray"></video>
              </div>

              <div id="sourceSelectPanel" style="display:none">
                <label for="sourceSelect">Change camera:</label>
                <select id="sourceSelect" class="form-control form-control-sm" style="max-width:400px">
                </select>
              </div>

              <!-- <label>Result:</label>
              <pre><code id="result"></code></pre> -->
            </section>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="dti" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog  modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">DTI Form</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modal_body">
        <table class="table table-sm table-bordered">
          <tr>
            <th></th>
            <th>Yes</th>
            <th>No</th>
          </tr>
          <tr>
            <td>Are you experiencing:<br><span class="float-right">a. Sore throat</span></td>
            <td><label for="q1y"><input type="radio" name="q1" id="q1y" value="1"></label></td>
            <td><label for="q1n"><input type="radio" name="q1" id="q1n" value="0" checked></label></td>
          </tr>
          <tr>
            <td><span class="float-right">b. Body Pains</span></td>
            <td><label for="q2y"><input type="radio" name="q2" id="q2y" value="1"></label></td>
            <td><label for="q2n"><input type="radio" name="q2" id="q2n" value="0" checked></label></td>
          </tr>
          <tr>
            <td><span class="float-right">a. Headache</span></td>
            <td><label for="q3y"><input type="radio" name="q3" id="q3y" value="1"></label></td>
            <td><label for="q3n"><input type="radio" name="q3" id="q3n" value="0" checked></label></td>
          </tr>
          <tr>
            <td><span class="float-right">a. Fever</span></td>
            <td><label for="q4y"><input type="radio" name="q4" id="q4y" value="1"></label></td>
            <td><label for="q4n"><input type="radio" name="q4" id="q4n" value="0" checked></label></td>
          </tr>
          <tr>
            <td>Have you worked together or stayed in the same close environment of a confirmed COVID19 case?</td>
            <td><label for="q5y"><input type="radio" name="q5" id="q5y" value="1"></label></td>
            <td><label for="q5n"><input type="radio" name="q5" id="q5n" value="0" checked></label></td>
          </tr>
          <tr>
            <td>Have you had any contact with anyone with fever, cough, colds, and sore throat in the past 2 weeks?</td>
            <td><label for="q6y"><input type="radio" name="q6" id="q6y" value="1"></label></td>
            <td><label for="q6n"><input type="radio" name="q6" id="q6n" value="0" checked></label></td>
          </tr>
          <tr>
            <td>Have you travelled outside of the Philippines in the last 14 days?</td>
            <td><label for="q7y"><input type="radio" name="q7" id="q7y" value="1"></label></td>
            <td><label for="q7n"><input type="radio" name="q7" id="q7n" value="0" checked></label></td>
          </tr>
          <tr>
            <td>Have you travelled to any area in NCR or Metro Manila aside from your home?</td>
            <td><label for="q8y"><input type="radio" name="q8" id="q8y" value="1"></label></td>
            <td><label for="q8n"><input type="radio" name="q8" id="q8n" value="0" checked></label></td>
          </tr>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <!-- <button onclick="set_default_answers()" class="btn btn-outline-secondary float-left">Reset</button> -->
        <button type="button" class="btn btn-primary" id="dti_submit" onclick="get_answers()">Submit</button>
      </div>
    </div>
  </div>
</div>
  <script type="text/javascript" src="js/qrscanner.js"></script>
  <script src="js/aes.js"></script>
  <script type="text/javascript">
    var db = openDatabase('CTracer_DB', '1.0', 'Contact Tracing List', 2 * 1024 * 1024);
    db.transaction(function (tx) {
      tx.executeSql('CREATE TABLE IF NOT EXISTS ctracer (id INTEGER PRIMARY KEY,data TEXT);');
    });

    function decodeOnce(codeReader, selectedDeviceId) {
      codeReader.decodeFromInputVideoDevice(selectedDeviceId, 'video').then((result) => {
        // document.getElementById('result').textContent = result.text
        set_default_answers();
        process_result(result.text,true);
        //ADD DTI FORM HERE
        // alert(result);
        // $("#modal").modal("hide");
        // $("#dti").modal("show");
      }).catch((err) => {
        console.error(err)
        // document.getElementById('result').textContent = err
      })
    }

    function decodeContinuously(codeReader, selectedDeviceId) {
      codeReader.decodeFromInputVideoDeviceContinuously(selectedDeviceId, 'video', (result, err) => {
        if (result) {
          // document.getElementById('result').textContent = result.text
          process_result(result.text);
          alert(result.text);
        }
      })
    }
    let selectedDeviceId;
    const codeReader = new ZXing.BrowserQRCodeReader();
    window.addEventListener('load', function () {
      codeReader.getVideoInputDevices()
        .then((videoInputDevices) => {
          const sourceSelect = document.getElementById('sourceSelect')
          selectedDeviceId = videoInputDevices[0].deviceId
          if (videoInputDevices.length >= 1) {
            var c = 0
            videoInputDevices.forEach((element) => {
              const sourceOption = document.createElement('option')
              sourceOption.text = element.label;
              sourceOption.value = element.deviceId;
              if(c == 1){
                if(getMobileOperatingSystem()!="unknown"){
                  selectedDeviceId = videoInputDevices[1].deviceId;
                  sourceOption.selected = "selected";
                }
              }
              sourceSelect.appendChild(sourceOption);
              c++;
            })
            sourceSelect.onchange = () => {
              selectedDeviceId = sourceSelect.value;
            };

            const sourceSelectPanel = document.getElementById('sourceSelectPanel')
            sourceSelectPanel.style.display = 'block'
          }

          document.getElementById('startButton').addEventListener('click', () => {
              start_scan();
            // console.log(`Started decode from camera with id ${selectedDeviceId}`)
          })

          document.getElementById('resetButton').addEventListener('click', () => {
            codeReader.reset()
            document.getElementById('result').textContent = '';
            // console.log('Reset.')
          })

        })
        .catch((err) => {
          console.error(err)
        })
    });
function getMobileOperatingSystem() {
  var userAgent = navigator.userAgent || navigator.vendor || window.opera;
    if (/windows phone/i.test(userAgent)) {
        return "Windows Phone";
    }
    if (/android/i.test(userAgent)) {
        return "Android";
    }
    if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
        return "iOS";
    }
    return "unknown";
}
function start_scan(){
    const decodingStyle = $('#decoding-style').val();
    if (decodingStyle == "once") {
      decodeOnce(codeReader, selectedDeviceId);
    } else {
      decodeContinuously(codeReader, selectedDeviceId);
    }
}
function get_answers(){
  var temp = {};
  for (var i = 1; i < 9; i++) {
    if($("input[name='q"+parseInt(i)+"']:checked").val()=="1"){
      temp["q"+parseInt(i)] = parseInt($("input[name='q"+parseInt(i)+"']:checked").val());
    }
  }
  temp_result_storage["dti"]=temp;
  // temp_result_storage["dti"]=JSON.stringify(temp);
  // console.log(temp_result_storage);
  save_data(temp_result_storage);
}
function change_mode(){
  const decodingStyle = $('#decoding-style').val();
  if(decodingStyle == "once"){
    location.reload();
  }else{
    $("#temp").val("");
    scan_qr();
  }
}
function stop_scan(){
    codeReader.reset();
    $('#result').html = '';
}
function scan_qr(){
  start_scan();
  $("#modal").modal("show");
}
$('#modal').on('hidden.bs.modal', function () {
  $("#dti_submit").removeClass("d-none");
  if($('#decoding-style').val() == "once"){
    stop_scan();
  }else{
    // location.reload();
    stop_scan();
  }
})
function set_default_answers(){
  for (var i = 8; i > 0; i--) {
    $("#q"+parseInt(i)+"n").trigger("click");
  }
}
function change(ch){
  if(ch!=null){
    if(ch=="."){
      if(!$('#temp').val().includes(".")){
        $('#temp').val($('#temp').val() + ch);
      } 
    }else{
      if(!isNaN(ch)){
        $('#temp').val($('#temp').val() + ch);
      }
    }
  }else{
    $('#temp').val($('#temp').val().slice(0, -1));
  }
}

$("#sourceSelect").change(function(){
  stop_scan();
  $("#modal").modal('hide');
  setTimeout(function(){ scan_qr(); }, 500);
});
function check(val){
  if(isNaN(val.val())){
    alert("Enter numbers ONLY!");
    val.val("");
  }
  val.on("keyup", function(event) {
    if (event.keyCode === 13) {
      scan_qr();
    }
  });
}
function cancel(){
      alert("Please generate a proper QR Code from http://tinyurl.com/universal-contact-tracing");
      $("#modal").modal('hide');
}
var temp_result_storage=null;
function process_result(result,solo=false){
  if(IsJsonString(result)){
    result = JSON.parse(result);
    if(!("firstName" in result)){
      cancel();
      return false;
    }
  }else{
    cancel();
    return false;
  }
  if(!solo){
    save_data(result);
  }else{
    // alert("SOLO");
    temp_result_storage = result;
    $("#modal").modal("hide");
    $("#dti").modal("show");
  }
}
function save_data(result){
  result["datetime"] = new Date().toLocaleString();
  result["temperature"] = $("#temp").val();
  db.transaction(function (tx) {
    const myCipher = cipher(sessionStorage.getItem("temp_key"));
    var sql = 'INSERT INTO ctracer (data) VALUES ("'+myCipher(JSON.stringify(result))+'")';
    tx.executeSql(sql, [], function (tx, results) {
    $("#main_screen").prepend(`<div class="alert alert-success alert-dismissible fade show" role="alert" style="position: absolute;left: 30%;top: 5vh;z-index: 1;">
        `+result["firstName"]+" "+result["lastName"]+` added!
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>`);
    $("#main_screen").focus();
    $("#main_screen").val("");
    $("#dti").modal("hide");
    });
  });
}
function clear_data(){
  db.transaction(function (tx) {
    tx.executeSql('SELECT * FROM ctracer', [], function (tx, results) {
      var len = results.rows.length, i;
      var data = null;
      var flag = false
      if(len!=0){
        try {
    const myDecipher = decipher(sessionStorage.getItem("temp_key"));
    data = myDecipher(results.rows[0]["data"]);
          flag=true;
        }
        catch(err) {
          alert("You provided the wrong encryption key!");
          get_key();
        }
      }
      if(flag && confirm("Press okay to clear table")){
      db.transaction(function (tx) {
        tx.executeSql('DROP TABLE ctracer', [], function (tx, results) {
            alert("Data has been deleted!");
            location.reload();
        });
      });
      }
    });
  });
}
function interpret_answers(results){
  results = results.split(",");
  console.log(results);
  $.each( results, function( i,v ){
    $("#"+v+"y").trigger("click");
    console.log("#"+v+"y");
  });
  $("#dti_submit").addClass("d-none");
  $("#dti").modal("show");
}
function history(){
  db.transaction(function (tx) {
    tx.executeSql('SELECT * FROM ctracer', [], function (tx, results) {
      $("#history_list").html("");
      var len = results.rows.length, i;
      $("#view_history").removeClass("d-none");
      $("#input_data").addClass("d-none");
      var data = null;
      var flag = false
      if(len!=0){
        try {
    const myDecipher = decipher(sessionStorage.getItem("temp_key"));
    data = myDecipher(results.rows[0]["data"]);
          flag=true;
        }
        catch(err) {
          alert("You provided the wrong encryption key");
          get_key();
          history();
        }
      }
      if(flag){
        for (i = 0; i < len; i++) {
    const myDecipher = decipher(sessionStorage.getItem("temp_key"));
    data = myDecipher(results.rows[i]["data"]);
          data = JSON.parse(data);
          var qq = Object.keys(data["dti"]);
          if(data["temperature"]!=""){data["temperature"] += "°C"}
          var temp = `<tr>
                      <td>`+data["datetime"].replace(',','<br>')+`</td>
                      <td>`+data["firstName"]+" "+data["middleName"]+" "+data["lastName"]+`</td>
                      <td>`+data["temperature"]+`</td>
                      <td>`+data["contactNumber"]+`</td>
                      <td>`+data["address"]+`</td>
                      <td>`+data["city"]+`</td>
                      <td>`+data["province"]+`</td>
                      <td><button class="btn btn-sm btn-outline-primary" onclick="interpret_answers('`+qq+`')"><small>`+(JSON.stringify(qq)).replace(",","-")+`</small></button><br></td>
                    </tr>`;
          $("#history_list").append(temp);
        }
      }
      $("#history_modal").modal("show");
    });
  });
}
function get_key(){
  var key = "";
  while(key==""){
    key = prompt("You need to enter an encryption key to secure the data collected through this app to avoid hacking. Please backup the encryption key as this will be required everytime you access the saved data.Copy the typed key before pressing okay.\n\nEnter encryption key:");
    if(key == null){
      key="";
    }
  }
  sessionStorage.setItem("temp_key", key);
  alert("Without this key, you will never access the data collected from this device ever again. Please make sure to backup this key.\n\nEntered key: "+key);
}
    // var encrypted = CryptoJS.AES.encrypt(result, sessionStorage.getItem("temp_key"));
  // var decryptedBytes = CryptoJS.AES.decrypt(encrypted, sessionStorage.getItem("temp_key")).toString(CryptoJS.enc.Utf8);
  // alert(decryptedBytes);

if (typeof(Storage) !== "undefined") {
  if(sessionStorage.getItem("temp_key")==null){
    get_key();
    history();
  }
  // sessionStorage.setItem("temp_key", "Test");
  // if(sessionStorage.getItem("temp_key")!=null){
  //   alert(sessionStorage.getItem("temp_key"));
  // }
} else {
  alert("Sorry, your browser does not support Web Storage...");
}
function IsJsonString(str) {
  try {
      JSON.parse(str);
  } catch (e) {
      return false;
  }
  return true;
}
$('#export').click(function() {
  var titles = [];
  var data = [];
  $('.dataTable th').each(function() {
    titles.push($(this).text());
  });
  $('.dataTable td').each(function() {
    data.push($(this).text());
  });
  var CSVString = prepCSVRow(titles, titles.length, '');
  CSVString = prepCSVRow(data, titles.length, CSVString);
  var downloadLink = document.createElement("a");
  var blob = new Blob(["\ufeff", CSVString]);
  var url = URL.createObjectURL(blob);
  downloadLink.href = url;
  downloadLink.download = "contact_tracing.csv";
  document.body.appendChild(downloadLink);
  downloadLink.click();
  document.body.removeChild(downloadLink);
});
function prepCSVRow(arr, columnCount, initial) {
  var row = ''; // this will hold data
  var delimeter = ','; // data slice separator, in excel it's `;`, in usual CSv it's `,`
  var newLine = '\r\n'; // newline separator for CSV row
  function splitArray(_arr, _count) {
    var splitted = [];
    var result = [];
    _arr.forEach(function(item, idx) {
      if ((idx + 1) % _count === 0) {
        splitted.push(item);
        result.push(splitted);
        splitted = [];
      } else {
        splitted.push(item);
      }
    });
    return result;
  }
  var plainArr = splitArray(arr, columnCount);
  plainArr.forEach(function(arrItem) {
    arrItem.forEach(function(item, idx) {
      row += item + ((idx + 1) === arrItem.length ? '' : delimeter);
    });
    row += newLine;
  });
  return initial + row;
}
const cipher = salt => {
    const textToChars = text => text.split('').map(c => c.charCodeAt(0));
    const byteHex = n => ("0" + Number(n).toString(16)).substr(-2);
    const applySaltToChar = code => textToChars(salt).reduce((a,b) => a ^ b, code);

    return text => text.split('')
        .map(textToChars)
        .map(applySaltToChar)
        .map(byteHex)
        .join('');
}

const decipher = salt => {
    const textToChars = text => text.split('').map(c => c.charCodeAt(0));
    const applySaltToChar = code => textToChars(salt).reduce((a,b) => a ^ b, code);
    return encoded => encoded.match(/.{1,2}/g)
        .map(hex => parseInt(hex, 16))
        .map(applySaltToChar)
        .map(charCode => String.fromCharCode(charCode))
        .join('');
}
  </script>
<style type="text/css">
  .footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 60px;
  }
  label {
    cursor: pointer;
    display: block;
    text-align: center;
}
/*
  .modal-dialog {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}
.modal-content {
  height: auto;
  min-height: 100%;
  border-radius: 0;
}*/
</style>
</body>

</html>
